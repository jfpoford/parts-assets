<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Barcode Grid Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1em; }
    canvas { border: 1px solid #aaa; }
    .controls label { display: block; margin: 0.5em 0; }
    .grid-overlay {
      position: absolute;
      border: 1px dashed red;
      box-sizing: border-box;
      cursor: move;
    }
    #canvas-container { position: relative; display: inline-block; }
    #output img { max-width: 100px; margin: 4px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Barcode Grid Splitter</h1>
  <input type="file" id="pdf-upload" accept="application/pdf">
  <div class="controls">
    <label>Columns: <input type="number" id="cols" value="2" min="1"></label>
    <label>Rows: <input type="number" id="rows" value="5" min="1"></label>
    <label>Top Margin: <input type="number" id="top-margin" value="55"></label>
    <label>Bottom Margin: <input type="number" id="bottom-margin" value="40"></label>
    <label>Left Margin: <input type="number" id="left-margin" value="10"></label>
    <label>Right Margin: <input type="number" id="right-margin" value="10"></label>
    <button id="process">Preview Grid</button>
    <button id="export" disabled>Export All Labels</button>
  </div>

  <div id="canvas-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <h2>Previews</h2>
  <div id="output"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('pdf-upload');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const processBtn = document.getElementById('process');
    const exportBtn = document.getElementById('export');
    const output = document.getElementById('output');
    const container = document.getElementById('canvas-container');

    let labelImages = [];
    let pageImage = null;

    let margins = {};
    let draggableBoxes = [];

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function () {
        const typedArray = new Uint8Array(reader.result);
        const pdfDoc = await pdfjsLib.getDocument({ data: typedArray }).promise;
        const page = await pdfDoc.getPage(1);
        const viewport = page.getViewport({ scale: 2 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        exportBtn.disabled = false;
        pageImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
      };
      reader.readAsArrayBuffer(file);
    });

    processBtn.addEventListener('click', () => {
      output.innerHTML = '';
      labelImages = [];
      draggableBoxes = [];
      const cols = parseInt(document.getElementById('cols').value);
      const rows = parseInt(document.getElementById('rows').value);
      margins.top = parseInt(document.getElementById('top-margin').value);
      margins.bottom = parseInt(document.getElementById('bottom-margin').value);
      margins.left = parseInt(document.getElementById('left-margin').value);
      margins.right = parseInt(document.getElementById('right-margin').value);

      const usableWidth = canvas.width - margins.left - margins.right;
      const usableHeight = canvas.height - margins.top - margins.bottom;
      const fullRowHeight = usableHeight / rows;
      const labelHeight = fullRowHeight * 0.9;
      const yOffset = (fullRowHeight - labelHeight) / 2;
      const labelWidth = usableWidth / cols;

      container.querySelectorAll('.grid-overlay').forEach(el => el.remove());

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const x = margins.left + col * labelWidth;
          const shift = -20 + (row >= rows - 2 ? -20 : 0);
          const y = margins.top + row * fullRowHeight + yOffset + shift;

          const overlay = document.createElement('div');
          overlay.className = 'grid-overlay';
          overlay.style.left = `${x}px`;
          overlay.style.top = `${y}px`;
          overlay.style.width = `${labelWidth}px`;
          overlay.style.height = `${labelHeight}px`;
          overlay.dataset.x = x;
          overlay.dataset.y = y;
          overlay.dataset.w = labelWidth;
          overlay.dataset.h = labelHeight;
          container.appendChild(overlay);

          makeDraggable(overlay);
          draggableBoxes.push(overlay);
        }
      }
    });

    function makeDraggable(el) {
      let isDragging = false, startX, startY, origX, origY;
      el.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        origX = parseInt(el.style.left);
        origY = parseInt(el.style.top);
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        el.style.left = `${origX + dx}px`;
        el.style.top = `${origY + dy}px`;
        el.dataset.x = origX + dx;
        el.dataset.y = origY + dy;
      });
      window.addEventListener('mouseup', () => isDragging = false);
    }

    exportBtn.addEventListener('click', () => {
      const zip = new JSZip();
      labelImages = [];
      output.innerHTML = '';
      draggableBoxes.forEach((box, i) => {
        const x = parseInt(box.dataset.x);
        const y = parseInt(box.dataset.y);
        const w = parseInt(box.dataset.w);
        const h = parseInt(box.dataset.h);

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w;
        tempCanvas.height = h;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(pageImage, -x, -y);
        const dataUrl = tempCanvas.toDataURL('image/png');

        const name = `label_${i + 1}.png`;
        zip.file(name, dataUrl.split(',')[1], { base64: true });

        const img = new Image();
        img.src = dataUrl;
        output.appendChild(img);
      });
      zip.generateAsync({ type: 'blob' }).then(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'labels.zip';
        a.click();
      });
    });
  </script>
</body>
</html>
